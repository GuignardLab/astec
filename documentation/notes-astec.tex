\documentclass{article}
\usepackage{fullpage}
\usepackage[usenames,dvipsnames]{xcolor}
\usepackage[linesnumbered,boxed]{algorithm2e}
\def \mycolor {red}

\newenvironment{remarque}{\color{red}\begin{description}\item[Rq:]}
{\end{description}\color{black}}

\begin{document}

overview of \verb|astec_process()|

\begin{itemize}

\item reconstruction d'une image de membrane 
(\verb|reconstruction.build_membrane_image()|)

\item calcul de $\tilde{S}_{t+1}$, c'est-\`a-dire la segmentation $S^{\star}_{t}$ d\'eform\'ee \`a $t+1$ 
\begin{displaymath}
\tilde{S}_{t+1} = S^{\star}_{t} \circ \mathcal{T}_{t \leftarrow t+1}
\end{displaymath}

\item calcul des images de graines $\mathrm{Seeds}^{h}_{t+1}$ pour $h \in [h_{min}, h_{max}]$ (\verb|_cell_based_h_minima()|)

\item s\'election des param\`etres, ie du nombre de graines pour chaque cellule "m\`ere" (\verb|_select_seed_parameters()|)

\end{itemize}


\subsection*{Nomenclature}

\begin{itemize}
\item $S^{\star}_t$ segmentation de $I_{t}$, suppos\'ee correcte
\item $\tilde{S}_{t+1}$ segmentation de $I_{t+1}$ avec la segmentation projet\'ee de $I_{t}$ (les graines sont les cellules \'erod\'ees de $S^{\star}_t$ projet\'ees sur $I_{t+1}$).
\begin{remarque}
L'\'erosion se fait en 26-connexit\'e, avec un nombre d'it\'erations diff\'erent pour les cellules (10) et le fond (25)). 
\end{remarque}
\end{itemize}


\section{Segmentation de l'image \`a $t+1$}

\subsection{$h$-minima}

On calcule plusieurs images de $h$-minima r\'egionaux $Seeds^{h}_{t+1}$, avec $h \in [h_{min}, h_{max}]$. On calcule d'abord une image de minima qui contient des minima de hauteur comprise entre 1 et $h$, et on ne s\'electionne que les minima de hauteur $h$ avec un seuillage par hyst\'er\'esis. 

On ne conserve que les minima qui sont enti\`erement inclus dans une seule cellule de $\tilde{S}_{t+1}$. On \'elimine donc les graines qui chevauchent plusieurs cellules. 
\begin{remarque}
De telles graines renseigneraient pourtant sur le contraste entre 2 cellules adjacentes (sous l'hypoth\`ese que les fronti\`eres des cellules dans $\tilde{S}_{t+1}$ soient correctement localis\'ees).
\end{remarque}

\subsection{\texttt{get\_back\_parameters()}}

\verb|get_back_parameters()| est la fonction dans \verb|ASTEC.py|, elle est renomm\'ee \verb|_select_seed_parameters()| dans \verb|astecnew.py|.

Pour chaque cellule $c$ ($c$ est un label de l'image $S^{\star}_t$, ou de $\tilde{S}_{t+1}$) et chaque $h$, on a donc un nombre de graines $Count^{h}(c)$ \cite[figure 2.9, page 72]{guignard:tel-01278725}. 
On peut calculer les nombres $N_{n}(c)$, $N_{n^{-}}(c)$, et $N_{n^{+}}(c)$  \cite[section 2.3.3.5, page 71]{guignard:tel-01278725}. 
\begin{itemize}
\itemsep -1ex
\item $N_{n^{-}}(c)$ est la plus petite valeur de $h \in  [N_{min}, N_{max}]$ donnant $n$ graines pour la cellule $c$
\begin{displaymath}
N_{n^{-}}(c) = \min \{ h | S(c,h) = n \}
\end{displaymath}
\item $N_{n^{+}}(c)$ est la plus grande valeur de $h \in  [N_{min}, N_{max}]$ donnant $n$ graines pour la cellule $c$
\begin{displaymath}
N_{n^{+}}(c) = \max \{ h | S(c,h) = n \}
\end{displaymath}
\item $N_{n}(c)$ est le nombre de  valeurs de $h \in  [N_{min}, N_{max}]$ donnant $n$ graines pour la cellule $c$
\begin{displaymath}
N_{n}(c) = N_{n^{+}}(c) - N_{n^{-}}(c) + 1
\end{displaymath}
\end{itemize}
Notons que ces nombres ne peuvent \^etre d\'efinis que s'il existe au moins un $h$ donnant 2 graines.

$h$ peut \^etre vu comme une mesure de contraste (si la hauteur de la membrane entre 2 cellules adjacentes est plus petite que $h$, alors il n'y aura qu'une seule 
Une premi\`ere hypoth\`ese est que le premier $h$ donnant plus de 2 graines est une mesure du "bruit" (consid\'er\'e comme un contraste) du "fond" de la cellule, ce premier $h$ est donc $N_{2^{-}}(c) - 1$. Il y a une vraie division si le contraste de la membrane entre les deux cellules apr\`es division est suffisamment \'elev\'e (ce contraste est estim\'e par $N_{2^{+}}(c)$) et si ce contraste est suffisamment diff\'erent du contraste du bruit, donc si la diff\'erence $N_{2^{+}}(c) - (N_{2^{-}}(c) - 1) = N_{2}(c)$ est suffisamment \'elev\'ee. D'o\`u le crit\`ere
\begin{equation}
s(c) = N_{2^{+}}(c) . N_{2}(c) > \tau
\end{equation}


Ces fonctions s\'electionnent, pour chaque cellule $c$, le bon jeu de param\`etres $(h,\sigma)$ [c'est le $\sigma$ de lissage pour le calcul des $h$-minima, mais en fait il est identique pour tous les $h$-minima], traduit cela par
\begin{enumerate}
\itemsep -1ex
\item S'il existe des $h$ donnant 1 ou 2 graines
\begin{enumerate}
\itemsep -0.5ex
\item si le score $s(c) = N_{2^{+}}(c) . N_2(c)$ est plus grand ou \'egal que $\tau$ (la th\`ese dit strictement), alors on garde 2 graines
\item sinon ($s(c) = N_{2^{+}}(c) . N_2(c) <\tau$) et il existe des $h$ donnant 1 graine, alors on garde 1 graine
\item sinon ($s(c) = N_{2^{+}}(c) . N_2(c) <\tau$ et il n'existe pas de $h$ donnant 1 graine) on garde 2 graines
\end{enumerate}
\item sinon (il n'existe pas de $h$ donnant 1 ou 2 graines) et il existe des $h$ donnant 3 graines, alors on garde 3 graines.
\begin{remarque}
Toutefois, dans la fonction \verb|get_seeds_from_optimized_parameters()| (dans \verb|ASTEC.py| ou \verb|_build_seeds_from_selected_parameters()| dans \verb|astecnew.py|)
cr\'eant l'image des graines num\'erot\'ees \`a partir des diff\'erentes images de $h$-minima, on ne r\'ecup\`ere que les deux premi\`eres composantes num\'erot\'ees \ldots On cr\'ee donc une division, avec un choix artificiel/al\'eatoire des cellules filles.
\end{remarque}
\item sinon  (il n'existe pas de $h$ donnant 1 ou 2 ou 3 graines), on dit qu'il n'y a pas de graines.
\begin{remarque}
Pourquoi ne pas consid\'erer le cas 3 graines comme le cas 4 graines ?
\end{remarque}
\end{enumerate}
On r\'ecup\`ere le premier $h$ donnant le nombre choisi de graines. Comme les $h$ sont parcourus par ordre d\'ecroissant, c'est donc le plus grand $h$ donnant ce nombre de graines qui est retenu.






\subsection{\texttt{get\_seeds\_from\_optimized\_parameters()}}

La fonction \verb|get_seeds_from_optimized_parameters()| (dans \verb|ASTEC.py| ou \verb|_build_seeds_from_selected_parameters()| dans \verb|astecnew.py|) construit une image de graines \`a partir des param\`etres retenus dans \verb|get_back_parameters()|.

\begin{itemize}
\item 1 graine: on r\'ecup\`ere la graine dans $Seeds^{h}_{t+1}$ pour la cellule $c$

\item 2 graines: on r\'ecup\`ere les 2 graines dans  $Seeds^{h}_{t+1}$ pour la cellule $c$

\item 3 graines: on ne r\'ecup\`ere que 2 graines (les deux premi\`eres num\'erot\'ees) dans  $Seeds^{h}_{t+1}$ pour la cellule $c$.
\begin{remarque}
Ce comportement doit \^etre corrig\'e.
\end{remarque}

\item 0 graine: on regarde si le volume de la cellule $c$ (dans $\tilde{S}_{t+1}$) est suffisamment grand (sup\'erieur \`a 100). 
Si oui, on r\'ecup\`ere alors la graine correspondante dans $S^e_{t+1 \leftarrow t} = S^e_t \circ \mathcal{T}_{t \leftarrow t+1}$ (cellules de $S^{\star}_t$ \'erod\'ees (10 it\'erations en 26-connexit\'e) puis transform\'ees).
\begin{remarque}
Il y a ici une potentielle fin de lin\'eage.
\end{remarque}

\item fond: on r\'ecup\`ere toutes les graines de $Seeds^{h_{min}}_{t+1}$ qui correspondent \`a la cellule $1$ (le fond). 

\end{itemize}

On 


\subsection{\texttt{volume\_checking()}}

Cherche \`a corriger des erreurs d\'etect\'ees par des changements de volume trop importants.

Pour une cellule $c^{t}_i


\cite{guignard:tel-01278725}

\bibliographystyle{unsrt}
\bibliography{bib-astec}

\end{document}